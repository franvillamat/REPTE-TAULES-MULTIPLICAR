<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mestre de les Taules - 3r PDC (Seguiment)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');

        body {
            font-family: 'Plus+Jakarta+Sans', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-table:hover {
            transform: translateY(-5px);
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px -5px rgba(59, 130, 246, 0.5);
        }

        .correct { animation: pulseGreen 0.5s ease; }
        .wrong { animation: shake 0.4s ease; }

        @keyframes pulseGreen {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <!-- Login View (Primer pas) -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950 p-4">
        <div class="glass p-8 rounded-[2rem] max-w-sm w-full text-center">
            <h2 class="text-2xl font-bold mb-6">Benvingut/da al Repte</h2>
            <p class="text-slate-400 mb-6 text-sm">Introdueix el teu nom i cognom per a registrar el teu progr√©s.</p>
            <input type="text" id="student-name" placeholder="El teu nom..." class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold transition-all">Comen√ßar a practicar</button>
        </div>
    </div>

    <!-- Header -->
    <header class="w-full max-w-4xl flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-extrabold bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">Mestre de les Taules</h1>
            <p id="user-display" class="text-slate-400">Usuari: ...</p>
        </div>
        <div class="glass px-4 py-2 rounded-2xl flex items-center gap-4">
            <div class="text-center">
                <p class="text-xs uppercase text-slate-500 font-bold">Punts</p>
                <p id="score" class="text-xl font-black text-blue-400">0</p>
            </div>
            <div class="text-center border-l border-slate-700 pl-4">
                <p class="text-xs uppercase text-slate-500 font-bold">Ratxa</p>
                <p id="streak" class="text-xl font-black text-orange-400">0 üî•</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app-container" class="w-full max-w-4xl pb-20">

        <!-- Menu Principal -->
        <div id="menu-view" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            <script>
                for(let i=1; i<=12; i++) {
                    document.write(`
                        <button onclick="startPractice(${i})" class="glass card-table p-6 rounded-3xl text-center group transition-all">
                            <span class="block text-4xl mb-2 group-hover:scale-110 transition-transform">‚úñÔ∏è</span>
                            <span class="block text-xl font-bold">Taula del ${i}</span>
                        </button>
                    `);
                }
            </script>
            <button onclick="startChallenge()" class="col-span-2 glass p-6 rounded-3xl text-center bg-gradient-to-br from-purple-600/20 to-blue-600/20 border-purple-500/30 hover:border-purple-500 transition-all">
                <span class="block text-4xl mb-2">‚ö°</span>
                <span class="block text-xl font-bold">MODE REPTE MIXT</span>
                <span class="text-xs text-purple-300">Totes les taules amb temps</span>
            </button>
        </div>

        <!-- Joc en curs -->
        <div id="game-view" class="hidden glass p-8 md:p-12 rounded-[2rem] text-center max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <button onclick="showMenu()" class="text-slate-400 hover:text-white flex items-center gap-2">
                    <span>‚Üê Tornar</span>
                </button>
                <div id="timer-container" class="hidden">
                    <span id="timer" class="text-2xl font-mono font-bold text-red-400">10s</span>
                </div>
            </div>
            <div class="mb-12">
                <p id="question-text" class="text-7xl md:text-8xl font-black tracking-tighter mb-4">7 √ó 8</p>
                <div id="feedback" class="h-8 text-lg font-bold"></div>
            </div>
            <div id="options-grid" class="grid grid-cols-2 gap-4"></div>
        </div>

        <!-- Resultats -->
        <div id="result-view" class="hidden glass p-8 rounded-[2rem] text-center max-w-md mx-auto">
            <h2 class="text-4xl font-black mb-4">Bravo! üéâ</h2>
            <p id="result-stats" class="text-xl text-slate-300 mb-8"></p>
            <p id="save-status" class="text-sm text-emerald-400 mb-4 font-bold"></p>
            <button onclick="showMenu()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-2xl font-bold transition-colors">Continuar practicant</button>
        </div>

        <!-- Secci√≥ de Seguiment (Nom√©s Professor) -->
        <div class="mt-20 border-t border-slate-800 pt-10">
            <button onclick="toggleTeacherView()" class="text-slate-600 text-xs hover:text-slate-400 transition-colors uppercase tracking-widest font-bold">
                Acc√©s Professor (Visualitzar Progr√©s)
            </button>
            <div id="teacher-view" class="hidden mt-6 glass p-6 rounded-2xl">
                <h3 class="text-xl font-bold mb-4 text-blue-400">Registre d'activitat de l'alumnat</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-slate-500 border-b border-slate-800">
                            <tr>
                                <th class="pb-2">Alumne/a</th>
                                <th class="pb-2">Activitat</th>
                                <th class="pb-2">Punts</th>
                                <th class="pb-2">Data</th>
                            </tr>
                        </thead>
                        <tbody id="teacher-logs">
                            <!-- Logs es carregaran aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CONFIGURACI√ì FIREBASE
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'taules-pdc';

        // ESTAT GLOBAL
        let studentName = "";
        let currentMode = 'practice';
        let currentTable = 1;
        let score = 0;
        let streak = 0;
        let questionCount = 0;
        let correctAnswer = 0;
        let timerInterval;
        let timeLeft = 10;
        let user = null;

        // AUTH & SYNC
        window.login = () => {
            const nameInput = document.getElementById('student-name').value.trim();
            if (nameInput.length < 3) {
                alert("Per favor, posa el teu nom real per a poder guardar el progr√©s.");
                return;
            }
            studentName = nameInput;
            document.getElementById('user-display').innerText = `Usuari: ${studentName}`;
            document.getElementById('login-view').classList.add('hidden');

            signInAnonymously(auth).catch(console.error);
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) loadTeacherLogs();
        });

        // FUNCIONS DEL JOC
        window.showMenu = () => {
            clearInterval(timerInterval);
            hideAll();
            document.getElementById('menu-view').classList.remove('hidden');
        };

        window.startPractice = (table) => {
            currentMode = 'practice';
            currentTable = table;
            resetGame();
            document.getElementById('timer-container').classList.add('hidden');
            nextQuestion();
            showView('game');
        };

        window.startChallenge = () => {
            currentMode = 'challenge';
            resetGame();
            document.getElementById('timer-container').classList.remove('hidden');
            nextQuestion();
            showView('game');
        };

        function resetGame() {
            score = 0;
            streak = 0;
            questionCount = 0;
            updateUI();
        }

        function nextQuestion() {
            if (questionCount >= 10 && currentMode === 'practice') {
                saveProgress();
                return;
            }

            const num1 = currentMode === 'practice' ? currentTable : Math.floor(Math.random() * 9) + 2;
            const num2 = Math.floor(Math.random() * 12) + 1;
            correctAnswer = num1 * num2;

            document.getElementById('question-text').innerText = `${num1} √ó ${num2}`;
            document.getElementById('feedback').innerText = '';
            generateOptions(correctAnswer);

            if (currentMode === 'challenge') resetTimer();
        }

        function generateOptions(correct) {
            const options = new Set([correct]);
            while(options.size < 4) {
                const wrong = correct + (Math.floor(Math.random() * 12) - 6);
                if (wrong > 0 && wrong !== correct) options.add(wrong);
            }
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            [...options].sort(() => Math.random() - 0.5).forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'glass py-6 rounded-2xl text-3xl font-bold hover:bg-slate-700 transition-colors';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, btn);
                grid.appendChild(btn);
            });
        }

        function checkAnswer(selected, element) {
            if (selected === correctAnswer) {
                score += 10;
                streak++;
                element.classList.add('correct', 'bg-emerald-600/40');
                setTimeout(nextQuestion, 600);
            } else {
                streak = 0;
                element.classList.add('wrong', 'bg-red-600/40');
                setTimeout(nextQuestion, 1200);
            }
            questionCount++;
            updateUI();
        }

        async function saveProgress() {
            document.getElementById('save-status').innerText = "Guardant progr√©s...";
            showView('result');
            document.getElementById('result-stats').innerText = `Has acabat la sessi√≥ amb ${score} punts!`;

            if (!user) return;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'scores'), {
                    student: studentName,
                    mode: currentMode,
                    table: currentMode === 'practice' ? currentTable : 'Mixta',
                    points: score,
                    timestamp: serverTimestamp()
                });
                document.getElementById('save-status').innerText = "Progr√©s guardat correctament al n√∫vol ‚úÖ";
            } catch (e) {
                document.getElementById('save-status').innerText = "Error en guardar. Avisa al profe.";
            }
        }

        // VISTA PROFESSOR
        window.toggleTeacherView = () => {
            const view = document.getElementById('teacher-view');
            view.classList.toggle('hidden');
        };

        function loadTeacherLogs() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
            // Nota: En l'entorn real, es filtraria per temps, aqu√≠ agafem els √∫ltims
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('teacher-logs');
                tbody.innerHTML = '';

                // Ordenem en mem√≤ria per data descendent (seguint les regles de no usar orderBy complex)
                const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                             .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                docs.forEach(data => {
                    const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'Recent';
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-slate-800/50";
                    tr.innerHTML = `
                        <td class="py-3 font-bold text-blue-300">${data.student}</td>
                        <td class="py-3 text-slate-400">Taula ${data.table}</td>
                        <td class="py-3 text-emerald-400 font-bold">${data.points}</td>
                        <td class="py-3 text-slate-500 text-xs">${date}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }, (error) => console.error("Error logs:", error));
        }

        // UTILS
        function hideAll() {
            ['menu-view', 'game-view', 'result-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
        }
        function showView(id) {
            hideAll();
            document.getElementById(id + '-view').classList.remove('hidden');
        }
        function updateUI() {
            document.getElementById('score').innerText = score;
            document.getElementById('streak').innerText = streak + (streak > 5 ? ' üî•' : ' ‚ú®');
        }
        function resetTimer() {
            clearInterval(timerInterval);
            timeLeft = 10;
            document.getElementById('timer').innerText = timeLeft + 's';
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft + 's';
                if (timeLeft <= 0) {
                    streak = 0;
                    updateUI();
                    nextQuestion();
                    questionCount++;
                }
            }, 1000);
        }
    </script>
</body>
</html>
